@* Views/ClientReservation/Book.cshtml *@
@model HotelAurelia.ViewModels.ClientReservationViewModel
@{
    ViewData["Title"] = "Book a Room";
}

<!--================Breadcrumb Area =================-->
<section class="breadcrumb_area">
    <div class="overlay bg-parallax" data-stellar-ratio="0.8" data-stellar-vertical-offset="0" data-background=""></div>
    <div class="container">
        <div class="page-cover text-center">
            <h2 class="page-cover-tittle">Reservation</h2>
            <ol class="breadcrumb">
                <li><a href="/">Home</a></li>
                <li class="active">Reservation</li>
            </ol>
        </div>
    </div>
</section>
<!--================Breadcrumb Area =================-->

<section class="booking_form_area sec_pad" style="background: #f8f9fa;">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- DEBUG: Display all form data on submit -->
                <div id="debugInfo" style="display: none; background: #fff3cd; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <h5>Debug Info:</h5>
                    <div id="debugContent"></div>
                </div>

                <!-- Validation Summary -->
                <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <!-- Success Message -->
                @if (TempData["SuccessMessage"] != null)
                {
                    <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
                        <i class="fa fa-check-circle mr-2"></i>@TempData["SuccessMessage"]
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                }

                <!-- Error Message -->
                @if (TempData["ErrorMessage"] != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
                        <i class="fa fa-exclamation-circle mr-2"></i>@TempData["ErrorMessage"]
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                }

                <!-- SIMPLIFIED FORM - No JavaScript dependencies -->
                <form asp-action="Book" method="post" id="bookingForm" onsubmit="return validateForm()">
                    @Html.AntiForgeryToken()

                    <div class="row">
                        <!-- Left Column: Booking Details -->
                        <div class="col-lg-8">
                            <div class="booking_card mb-4" style="background: white; border-radius: 8px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <h3 class="mb-4" style="color: #1a237e; font-weight: 600;">
                                    <i class="fa fa-calendar-alt mr-2"></i>Booking Details
                                </h3>

                                <!-- Date Selection -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label asp-for="DateDebut" class="form-label" style="color: #333; font-weight: 500;">
                                                <i class="fa fa-sign-in-alt mr-1"></i>Check-in Date *
                                            </label>
                                            <input asp-for="DateDebut" type="date" class="form-control"
                                                   style="border: 1px solid #ddd; padding: 10px; border-radius: 4px;"
                                                   min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                                            <span asp-validation-for="DateDebut" class="text-danger small"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label asp-for="DateFin" class="form-label" style="color: #333; font-weight: 500;">
                                                <i class="fa fa-sign-out-alt mr-1"></i>Check-out Date *
                                            </label>
                                            <input asp-for="DateFin" type="date" class="form-control"
                                                   style="border: 1px solid #ddd; padding: 10px; border-radius: 4px;"
                                                   min="@DateTime.Today.AddDays(1).ToString("yyyy-MM-dd")" />
                                            <span asp-validation-for="DateFin" class="text-danger small"></span>
                                        </div>
                                    </div>
                                </div>

                                @* <!-- Room Selection - SIMPLIFIED -->
                                <div class="form-group mt-4">
                                    <label class="form-label" style="color: #333; font-weight: 500;">
                                        <i class="fa fa-bed mr-1"></i>Select Room *
                                    </label>
                                    @if (Model.AvailableChambres.Any())
                                    {
                                        <select asp-for="ChambreId" class="form-control"
                                                style="border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                                            <option value="">-- Please select a room --</option>
                                            @foreach (var room in Model.AvailableChambres)
                                            {
                                                <option value="@room.Id">
                                                    Room @room.Numero - @room.Type (Sleeps @room.Capacite) - @room.Tarif.ToString("C")/night
                                                </option>
                                            }
                                        </select>
                                    }
                                    else
                                    {
                                        <div class="alert alert-warning">
                                            <i class="fa fa-exclamation-triangle mr-2"></i>
                                            No rooms available.
                                        </div>
                                    }
                                    <span asp-validation-for="ChambreId" class="text-danger small d-block mt-1"></span>
                                </div> *@
                                <div class="form-group mt-4">
                                    <label class="form-label" style="color: #333; font-weight: 500;">
                                        <i class="fa fa-bed mr-1"></i>Select Room *
                                    </label>
                                    @if (Model.AvailableChambres.Any())
                                    {
                                        <div class="row">
                                            @foreach (var room in Model.AvailableChambres)
                                            {
                                                <div class="col-md-6 mb-3">
                                                    <div class="room_option" style="
                                                                    border: 2px solid @(Model.ChambreId == room.Id ? "#ffd700" : "#e0e0e0");
                                                                    border-radius: 8px;
                                                                    padding: 15px;
                                                                    cursor: pointer;
                                                                    transition: all 0.3s ease;
                                                                    background: white;
                                                                " onclick="selectRoom(@room.Id)">
                                                        <div class="form-check">
                                                            <input class="form-check-input"
                                                                   type="radio"
                                                                   asp-for="ChambreId"
                                                                   value="@room.Id"
                                                                   id="room_@room.Id">
                                                            <label class="form-check-label w-100" for="room_@room.Id">
                                                                <div class="d-flex justify-content-between align-items-start">
                                                                    <div>
                                                                        <h5 class="mb-1" style="color: #1a237e;">Room @room.Numero</h5>
                                                                        <p class="mb-1 text-muted small">@room.Type • Sleeps @room.Capacite</p>
                                                                    </div>
                                                                    <h5 class="mb-0" style="color: #333;">@room.Tarif.ToString("C")<small class="text-muted">/night</small></h5>
                                                                </div>
                                                                @if (!string.IsNullOrEmpty(room.Image))
                                                                {
                                                                    <img src="~/image/chambres/@room.Image"
                                                                         alt="Room @room.Numero"
                                                                         class="img-fluid mt-2 rounded"
                                                                         style="width: 100%; height: 150px; object-fit: cover;">
                                                                }
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="alert alert-warning">
                                            <i class="fa fa-exclamation-triangle mr-2"></i>
                                            No rooms available for the selected dates.
                                        </div>
                                    }
                                    <span asp-validation-for="ChambreId" class="text-danger small d-block mt-1"></span>
                                </div>


                                <!-- Service Selection -->
                                <div class="form-group mt-4">
                                    <label class="form-label" style="color: #333; font-weight: 500;">
                                        <i class="fa fa-concierge-bell mr-1"></i>Additional Services (Optional)
                                    </label>
                                    <select asp-for="ServiceId" class="form-control"
                                            style="border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                                        <option value="">-- No additional service --</option>
                                        @foreach (var service in Model.AvailableServices)
                                        {
                                            <option value="@service.Id">
                                                @service.Nom - @service.Tarif.ToString("C")
                                            </option>
                                        }
                                    </select>
                                </div>

                                <!-- Special Requests -->
                                <div class="form-group mt-4">
                                    <label asp-for="SpecialRequests" class="form-label" style="color: #333; font-weight: 500;">
                                        <i class="fa fa-comment-alt mr-1"></i>Special Requests
                                    </label>
                                    <textarea asp-for="SpecialRequests" class="form-control" rows="3"
                                              style="border: 1px solid #ddd; padding: 10px; border-radius: 4px;"
                                              placeholder="Any special requests or notes..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Price Summary -->
                        <div class="col-lg-4">
                            <div class="price_summary_card" style="background: white; border-radius: 8px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <h4 class="mb-4" style="color: #1a237e; font-weight: 600;">
                                    <i class="fa fa-receipt mr-2"></i>Price Summary
                                </h4>

                                <!-- Static Price Info -->
                                <div class="price_breakdown mb-4">
                                    <p class="text-muted mb-3">
                                        Total price will be calculated based on your selection and number of nights.
                                    </p>

                                    <div class="important_notes mb-4">
                                        <h6 class="mb-3" style="color: #333; font-weight: 600;">
                                            <i class="fa fa-info-circle mr-2"></i>Important Notes
                                        </h6>
                                        <ul class="list-unstyled" style="font-size: 0.9rem; color: #666;">
                                            <li class="mb-2">
                                                <i class="fa fa-check-circle text-success mr-2"></i>
                                                Free cancellation up to 24 hours before check-in
                                            </li>
                                            <li class="mb-2">
                                                <i class="fa fa-check-circle text-success mr-2"></i>
                                                Check-in: After 2:00 PM
                                            </li>
                                            <li class="mb-2">
                                                <i class="fa fa-check-circle text-success mr-2"></i>
                                                Check-out: Before 12:00 PM
                                            </li>
                                        </ul>
                                    </div>

                                    <!-- Submit Button -->
                                    <button type="submit" class="btn theme_btn button_hover">
                                            
                                        Reserver
                                    </button>

                                    <!-- Cancel Link -->
                                    <div class="text-center mt-3">
                                        <a href="@Url.Action("Index", "Profile")" class="text-muted" style="font-size: 0.9rem;">
                                            <i class="fa fa-times mr-1"></i>Cancel booking
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        // Debug function to see what's being submitted
        function debugFormData(form) {
            var debugContent = '';
            var formData = new FormData(form);

            debugContent += '<table class="table table-sm">';
            for (var pair of formData.entries()) {
                debugContent += '<tr><td><strong>' + pair[0] + '</strong></td><td>' + pair[1] + '</td></tr>';
            }
            debugContent += '</table>';

            document.getElementById('debugContent').innerHTML = debugContent;
            document.getElementById('debugInfo').style.display = 'block';
        }

        // Simple form validation
        function validateForm() {
            console.log('Form submission triggered');

            var form = document.getElementById('bookingForm');

            // Debug: Show what's being submitted
            debugFormData(form);

            // Basic validation
            var checkIn = document.querySelector('[name="DateDebut"]').value;
            var checkOut = document.querySelector('[name="DateFin"]').value;
            var room = document.querySelector('[name="ChambreId"]').value;

            if (!checkIn || !checkOut) {
                alert('Please select both check-in and check-out dates');
                return false;
            }

            if (!room) {
                alert('Please select a room');
                return false;
            }

            var checkInDate = new Date(checkIn);
            var checkOutDate = new Date(checkOut);

            if (checkOutDate <= checkInDate) {
                alert('Check-out date must be after check-in date');
                return false;
            }

            console.log('Form validation passed');
            return true;
        }

        // Auto-dismiss alerts
        $(document).ready(function() {
            setTimeout(function() {
                $('.alert').alert('close');
            }, 5000);

            // Show debug info on form submit
            $('#bookingForm').on('submit', function(e) {
                console.log('Form submit event fired');
                if (!validateForm()) {
                    e.preventDefault();
                    return false;
                }

                // Disable submit button to prevent double submission
                $(this).find('button[type="submit"]')
                    .prop('disabled', true)
                    .html('<i class="fa fa-spinner fa-spin mr-2"></i>Processing...');

                return true;
            });
        });
    </script>
}